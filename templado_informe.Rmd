---
title: "Análisis metagenómico de la diversidad de plancton en la zona epipelágica del golfo de México"
author: "Grupo Bioinformatica"
date: "Informe `r format(Sys.Date())`"
output: 
  word_document 
#    reference_docx: 
# output: pdf_document
---

```{r setup, include=FALSE}
# Setting global option in all the chunks-code
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```

## Generalidad del análisis

Los datos provienen de muestras obtenidas en *42* estaciones que cubrió el crucero exploratorio *XIXIMI-06* Para cada muestra se generaron amplicones de la región v9 del gen ribosomal 18S. Los amplicones fueron secuenciados desde ambos extremos generando secuencias con una longitud de 150 pares de bases (pb) cada uno, en un secuenciador MiSeq de Illumina (del cicese-cigom). Los siguientes resultados corresponden al análisis bioinformático de las secuencias generadas.

El resumen del análisis se divide entre en tres etapas cruciales:
*Pre-procesamiento y alineamiento de lecturas. 
*Identificación, abundancia y clasificación taxonómica de OTUs.
*Estimación de los índices de diversidad y presentación gráfica resultados.

### Pre-procesamiento y alineamiento de lecturas

Durante el pre-procesamiento se demultiplexa y eliminan secuencias ambiguas y de puntaje de calidad phred menor a 20. La siguiente imagen resume las métricas de las bibliotecas illumina obtenidas para el crucero exploratorio (Figura 1 y 2).


```{r, fig.align = "center", fig.cap = "Figura 1. Promedio del puntaje de calidad Phred a lo largo de las lecturas de las bibliotecas. Bibliotecas Forward (R1) y Reverse (R2)."}

library("fastqcr")
library("ggplot2")
# First processes the quality screening by: fastqc *.fastq.gz -o fastqc/
#qc.dir <- c("/Users/cigom/metagenomics/example_samples/fastqc")
qc.dir <- c("/Users/cigom/metagenomics/phyloseq_in/fastqc/")
qc.files <- list.files(qc.dir, full.names = TRUE)

sample_names <- strsplit(dir(qc.dir), "_")
sample_names <- sapply(sample_names, "[", c(1,4))
sample_names <- as.data.frame(t(sample_names))
colnames(sample_names) <- c("Id","End")

qc <- qc_read_collection(qc.files, sample_names = sample_names$End, modules = c("Per sequence quality scores", "Per base sequence quality"))
qc_plot_collection(qc, modules = "Per sequence quality scores") +   theme_classic() + geom_line(size=1)

```

```{r, fig.align = "center", fig.cap = "Figura 2. Promedio del puntaje de calidad Phred por posición de nucleótido a lo largo de las lectura. Bibliotecas Forward (R1) y Reverse (R2)."}

qc_plot_collection(qc, modules = "Per base sequence quality") +   theme_classic() + geom_line(size=2)

```

El análisis metagenómico se llevó a cabo en el cluster de cómputo OMICA-cicese mediante el programa mothur version 1.39.5. La tubería del análisis fue adaptada del sugerido por  Schloss et al. 2013 para amplicones de la región v9 del gen 18S rRNA secuenciados por Illumina. Después del pre-procesamiento, las lecturas se transformaron a un set de secuencias unicas para implementar el alineamiento con la región v9  de la base de secuencias de referencia Silva v128 (Oliver-Glockner et. al. 2014). Entre aquellas que presentaron homología con la base de referencia mayor al 50% en identidad se implementa un paso de filtrado para eliminar falsos homopolímeros (max=10) y se volvieron a identificar secuencia únicas, posteriormente se quitaron aquellas secuencias que podrían tener al menos 2 cambios en nucleótidos, en base a la matriz generada en el alineamiento (Figura 3). 

## Identificación, abundancia y clasificación taxonómica de OTUs

Se removieron quimeras implementando la herramienta VSEARCH (Mahé F. et. al., 2016); las secuencias resultantes fueron agrupadas mediante el algoritmo Opticlust (Schloss et. al., 2017) tomando un parámetro de 97% de similitud entre secuencias para ser consideradas pertenecientes una unidad taxonómica operacional (OTU). Se realizó la asignación taxonómica de las secuencias procesadas usando un algoritmo de clasificación de Bayes ingenuo (Wang, 2007) y se obtuvo la taxonomía consenso para cada OTU. La base de datos para asignación taxonómica está compuesta de las secuencias de la base de datos W2-PR2 (de Vargas, 2015) que fue generada en un estudio metagenómico de amplio muestreo (descargada de su sitio web el 2 de Mayo de 2017) en la que se implementó la nomenclatura utilizada en la base de datos del registro mundial de especies marinas: WORMS (WoRMS Editorial Board, 2017). La figura 3 resume la abundancia de secuencias obtenidas a través del análisis metagenómico :

```{r, echo = FALSE, fig.align = "center", fig.cap = "El número de secuencias totales (azul), secuencias de buena calidad (GQ, rojo), secuencias Alineadas y quimeras removidas (ANC, Amarillo) y secuencias clasificadas en el linaje Animal (Verde) a lo largo de las estaciones."}

```

## Estimación de los índices de diversidad y presentación gráfica resultados

La estimación de los índices de diversidad y la generación de representaciones gráficas de los resultados del análisis metagenómico, se realizó en R v3.4 (R Core Team, 2017) utilizando diferentes paquetes especializados en análisis de datos ecológicos y gráficos.  

Para obtener una perspectiva biológica de la las comunidades planctónicas se calculó la abundancia relativa a nivel taxón los OTUs obtenidos por estación. El siguiente grupo de figuras (Figura 4,5,6,7 y 8) muestran en mapas de calor la composición de las comunidades a los diferentes rangos taxonómicos indicados (Filo, Clase, Orden, Familia, Género). Se muestran únicamente aquellos taxones cuya abundancia relativa supera el porcentaje señalado. Para una mejor visualización de los grupos de organismos en la figura correspondiente al rango Género, los organismos se agrupan e indican sus rangos Filos y Clase correspondientes, en las columnas del panel izquierdo (Figura 8). 

Aquellos taxones denominados como 'unclassified' denotan que no es posible asignar un nombre al rango taxonómico actual y en cambio indican el nombre del último rango asignado posible. Esta tendencia se acentúa conforme se baja de rango taxonómico (sentido Reino a Especie) y depende del grupo de organismos evaluado.

```{r phyloseq, echo = FALSE}
library(phyloseq)
# Path files for processing within phyloseq
#biom.dir <- c("/Users/cigom/metagenomics/example_samples/phyloseq_in")
biom.dir <- c("/Users/cigom/metagenomics/phyloseq_in/")
mbiom = list.files(biom.dir, full.names = TRUE, pattern = "biom")
mgroup = list.files(biom.dir, full.names = TRUE, pattern = "cigom.groups")

# An example of group file could be created as using the files file inputed in mothur
# cat cigom.files | awk '{print $1}' > groups
# cat cigom.files | awk '{print $1}' | cut -d"_" -f1,2,3,4,5 | sed 's/_/ /g' > factors
# paste groups factors | sed '1iID Run Cruice Station Barcode SampleType' | tr "\t" " " > cigom.groups

# Format sample(group) names

group = read.csv(mgroup[1], header=T, stringsAsFactors = FALSE, sep = "")
rownames(group) <- group[, 1]
mgroup = sample_data(group)


# load biom

biom <- import_biom(mbiom[1])
# and include sampledata
if (identical(colnames(otu_table(biom)), rownames(mgroup))) { obj <- merge_phyloseq(biom, mgroup) }


# Finally prepare a tre based on the representative-OTU-clusters sequence aligned in the classification step
# Also remember rename the fasta-aligned headers in order to converge the rest of the analysis
# awk '/^>/{gsub(/[|]/, " "); print ">"$2; next}{print}' < 0.03.rep.fasta > cigom.0.03.rep.treein.fasta 
# mothur > clearcut(fasta=cigom.0.03.rep.treein.fasta, DNA=T)

library(ape)

mtree <- list.files(biom.dir, full.names = TRUE, pattern = "*.rep.treein.tre")

t = read.tree(mtree[1])

# /// Merging a phyloseq object
if (identical(taxa_names(obj), sort(t$tip.label))) { phyloseq = merge_phyloseq(obj, t) 
    }  else { phyloseq = obj }

# parsing colnames (rename ranks)  and rownames (for taxa==OTU names, TRUE)

Rank <- c("Kingdom", "Phylum", "Class", "Order", 
                   			 "Family", "Genus", "Species")


colnames(tax_table(phyloseq)) <- c(Rank, "Extra1")
tax_table(phyloseq)[,8] <- 7

for(i in ncol(tax_table(phyloseq)):1) {
    # it will replace 'unknown_unclassified' terms for 'Unknown' term
    tax_table(phyloseq)[,i] <- sub("unknown", "Unknown", tax_table(phyloseq)[,i])
    tax_table(phyloseq)[,i] <- sub("unknown.*", "Unknown", tax_table(phyloseq)[,i])
#   Sub taxa with *nclassified with Undetermined term
    tax_table(phyloseq)[,i] <- sub(".*nclassified.*", 
    "Undetermined", tax_table(phyloseq)[,i], perl=TRUE)
#   Instead of Undetermined classified , use NA
    tax_table(phyloseq)[,i][grep("Undetermined|Unknown|NA",
                        tax_table(phyloseq)[,i], perl=TRUE)] <- NA
#   Define max resolution per taxa    
    tax_table(phyloseq)[is.na(tax_table(phyloseq)[,i]), "Extra1"] <- i-1
}

```

```{r}
# preprocessing count-matrix

# head(as(otu_table(phyloseq), "matrix")[,26]) # compare it ...
# head(as(otu_table(phyloseq), "matrix")[,26] > 2)  # with this .. then:
# length(apply(as(otu_table(phyloseq), "matrix") > 2, MARGIN = 1, sum))
keepTaxa = apply(X = as(otu_table(phyloseq), "matrix") > 0,
                 MARGIN = 1, FUN = sum) > 2 ## Remove OTUs not k greater than k (2L)
table(keepTaxa)
clean.phyloseq = prune_taxa(keepTaxa, phyloseq) 
```


```{r Animalia}
# And keep Animalia only:
Animalia <- subset_taxa(phyloseq, Kingdom == "Animalia")
# And removing any missing i.e. abundance of zero
Animalia <- prune_taxa(taxa_sums(Animalia) > 0, Animalia) 
```


```{r}
# Filter by Across-Sample Criteria
library(RColorBrewer)
theme_set(theme_classic())

taxaSums <- plyr::ldply(taxa_sums(Animalia), rbind)
colnames(taxaSums) <- c("Taxa", "Size")
taxaSums <- taxaSums[order(-taxaSums[,2]),]
# hist(taxaSums$Size) 


sampleSums <- plyr::ldply(sample_sums(Animalia), rbind)
colnames(sampleSums) <- c("Sample", "Abundance")
sampleSums <- sampleSums[order(-sampleSums[,2]),]


Animalia <- transform_sample_counts(Animalia, function(x) (x / sum (x) ))
Animalia <- transform_sample_counts(Animalia, function(x) x * 100 ) 

#Aprune <- filter_taxa(Animalia, function(x) sum(x > 1) > (0.1*length(x)), TRUE)

# niceplot for small subset 
# plot_bar(phyloseq, "Family", fill="Phylum", facet_grid=~Station) 
# .. geom_bar(stat="identity") +
#      scale_fill_brewer(palette="Spectral")

```

```{r, fig.align = "center", fig.cap = "Figura 4. Composición de las comunidades a nivel Filo a lo largo de las estaciones. Abundancia relativa de los taxones que alcanzan más del 1% en la comunidad.", out.width='\\textwidth'}
# Agglomerate taxa of the same Specie type [phylotyping] // demora 1-2 min //
Phylum <-tax_glom(Animalia, taxrank="Phylum")

plot_heatmap(Phylum, "NMDS", "bray", 
             sample.label = "Station", 
             taxa.label = "Phylum",
             na.value = "white", trans = NULL,
             low = "#FFFFD9", high = "#081D58") +
        labs(fill = "Relative\nAbundance (%)")
```


```{r, fig.align = "center", fig.cap = "Figura 5. Composición de las comunidades al nivel Clase a lo largo de las estaciones. Abundancia relativa de los taxones que alcanzan más del 2 % en la comunidad."}
Class <-tax_glom(Animalia, taxrank="Class")

plot_heatmap(Class, "NMDS", "bray", 
             sample.label = "Station", 
             taxa.label = "Class",
             na.value = "white", trans = NULL,
             low = "#FFFFD9", high = "#081D58") +
         labs(fill = "Relative\nAbundance (%)")
```

```{r , fig.align = "center", fig.cap="Figura 6. Composición de las comunidades a nivel Orden a lo largo de las estaciones. Abundancia relativa de los taxones que alcanzan más del 5 % en la comunidad.", fig.height = 7, fig.width = 5}
Order <-tax_glom(Animalia, taxrank="Order")

plot_heatmap(Order, "NMDS", "bray", 
             sample.label = "Station", 
             taxa.label = "Order",
             na.value = "white", trans = NULL,
             low = "#FFFFD9", high = "#081D58") +
         labs(fill = "Relative\nAbundance (%)")

```


```{r , fig.align = "center", fig.cap="Figura 7. Composición de las comunidades a nivel Familia a lo largo de las estaciones. Abundancia relativa de los taxones que alcanzan más del 5 % en la comunidad", fig.width = 5, fig.height = 7}

Family <-tax_glom(Animalia, taxrank="Family")

plot_heatmap(Family, "NMDS", "bray", 
             sample.label = "Station", 
             taxa.label = "Family",
             na.value = "white", trans = NULL,
             low = "#FFFFD9", high = "#081D58") +
        labs(fill = "Relative\nAbundance (%)")
```


```{r, fig.align = "center", fig.cap = "Figura 8. Composición de las comunidades a nivel Género a lo largo de las estaciones. Abundancia relativa de los taxones que alcanzan más del 5% en la comunidad. Respectivamente, se indican sus rangos Filos y Clase correspondientes en las columnas del panel izquierdo", fig.width = 5, fig.height = 6}

Genus <-tax_glom(Animalia, taxrank="Genus")

h <- plot_heatmap(Genus, "NMDS", "bray", 
             sample.label = "Station", 
             taxa.label = "Genus",
             na.value = "white", trans = NULL,
             low = "#FFFFD9", high = "#081D58")

h + facet_grid(Phylum+Class ~ ., 
               scales = "free", space = "free" 
    #                             switch = "y"
              ) + 
  theme(
  strip.text.y = element_text(
                        angle = 0, 
                        size = 5),
  strip.background = element_rect(colour = "black", 
                                  fill = "transparent",
                                  size = 0.1),
  panel.spacing = unit(0.01, "lines")
       ) +
  labs(fill = "Relative\nAbundance (%)")
```


```{r, echo = FALSE, fig.align = "center", fig.cap = "Figura 9. Curva de rarefacción que presenta la riqueza de OTUs a lo largo de las estaciones en relación al número de secuencias"}
# https://github.com/gauravsk/ranacapa/
# and https://github.com/joey711/phyloseq/issues/143

library(ranacapa)

rr <- subset_taxa(phyloseq, Kingdom == "Animalia")
minsample <- min(sample_sums(rr))

rrplot <- ggrare(rr, step = 100, label = "Station", 
                 #color="Station", 
                 se = FALSE, plot = FALSE) 

rrplot +
  xlab("Sequences number") + ylab("OTUs number") + 
    theme(text = element_text(size=12),
        panel.background = element_blank()) +
  geom_point(size=0.7) +
  geom_hline(yintercept = 100, linetype = "dashed")
```

En el siguiente enlace externo se encuentran la tabla de los índices de diversidad alfa: PATHTOTHEFILE

```{r, fig.align = "center", fig.cap = "Diversidad alpha"}
prichnes <- plot_richness(rr, x="Station", color="Station", measures=c("Chao1", "Shannon", "InvSimpson"))
prichnes$layers <- prichnes$layers[-1]
prichnes + geom_point(size=5, alpha=0.5) +
    scale_fill_manual(values = getPalette(nsamples(rr)))
```

La diferencia en composición de la comunidad de zooplancton entre estaciones se evaluó mediante un análisis de coordenadas principales usando una matriz de distancias Jaccard. En la figura 10 se observa que la mayoría de las estaciones forman agrupaciones indicando comunidades similares mientras que son pocas estaciones que se separan, indicando comunidades diferentes al resto del grupo.

```{r, fig.align = "center", fig.cap = "Figura 10. PCoA. Componentes principales (Distancias Jaccard)."}

iDist <- distance(rr, method="binary") # Jaccard
iMDS  <- ordinate(rr, "PCoA", distance=iDist) 

p <- plot_ordination(rr, iMDS
                     #color="Station"
                     #label="Station" 
                     #shape="Cruice"
                     ) 
p$layers <- p$layers[-1]
p + geom_text(aes(label = Station, label.size = 10)) 

```

```{r, fig.align = "center", fig.cap = "top de filos (abundancia de otus) a lo largo de todas las estaciones. Aquellos que representan almenos 10% dela abundancia total por muestra"}

# also try: https://github.com/joey711/phyloseq/issues/494
library(data.table)

keepTaxa = apply(X = as(otu_table(rr), "matrix") > 2L,
                 MARGIN = 1, FUN = sum) >= 2L ## Remove OTUs not k greater than k (2L)
phy = prune_taxa(keepTaxa, rr) # get abundance in %
phy <- transform_sample_counts(phy, function(x) x/sum(x)) # agglomerate taxa
glom <- tax_glom(phy, taxrank = 'Phylum') # create dataframe from phyloseq object
dat <- data.table(psmelt(glom)) # convert Phylum to a character vector from a factor because R
dat$Phylum <- as.character(dat$Phylum) # group dataframe by Phylum, calculate median rel. abundance
dat[, median := median(Abundance, na.rm = TRUE), 
    by = "Phylum"] # Change name to remainder of Phylum less than 1%
dat[(median <= 0.01), Phylum := "Remainder"]

# boxplot
ggplot(dat[Abundance > 0],
       aes(x=Phylum,
           y=Abundance)) + 
  geom_boxplot() + 
  coord_flip() +
  scale_y_log10()
```


```{r, fig.align = "center", fig.cap = "top de otus (abundancia) a lo largo de todas las estaciones. Aquellos que representan almenos 10% dela abundancia total por muestra"}

#xglom <- subset_taxa(Animalia, Family!="NA")
#zglom <- tax_glom(xglom, taxrank = 'Family')

f1 <- filterfun_sample(topp(0.1)) # fraction of the most abundant taxa to be kept
wh1 <- genefilter_sample(Family, f1, A=42) # in all of the samples in which a taxa/OTU passed the filter
ts <- prune_taxa(wh1, Family)
ts
dp <- psmelt(ts)

#dp <- phyloseq::psmelt(rr)
colourCount = length(unique(tax_table(ts)[,3]))
getPalette = colorRampPalette(brewer.pal(9, "Spectral"))

library(ggpubr)

ggdotchart(dp, x = "Station", y ="Family",
 group = "Station", color = "Phylum",
   palette = getPalette(colourCount),
   rotate = TRUE,
   sorting = "descending",
   ggtheme = theme_bw(),
   y.text.col = TRUE,
   dot.size = "Abundance") + 
  theme(axis.text.x = element_text(angle = 90))
```

## Visualizacion de hexanauplia

```{r, echo = FALSE}
library(phyloseq)
Hx.cls = subset_taxa(phyloseq, Class=="Hexanauplia")
Hx.cls = prune_samples(sample_sums(Hx.cls)>=20, Hx.cls) # filter where the sum of sample are higher than 20 barcodes per sample. ie.  remove samples with less than 20 total reads
Hx.cls <- transform_sample_counts(Hx.cls, function(x) (x / sum (x) )) 
Hx.cls <- transform_sample_counts(Hx.cls, function(x) x * 100 ) 
```


```{r, echo = FALSE}
# and interpolating large color pallete
# https://www.r-bloggers.com/how-to-expand-color-palette-with-ggplot-and-rcolorbrewer/
library(RColorBrewer)
colourCount = length(unique(tax_table(Hx.cls)[,5]))
getPalette = colorRampPalette(brewer.pal(9, "Spectral"))
```

```{r, fig.align = "center", fig.cap="Hexanauplia subset through the samples (Family label in the xlab)", fig.width = 7}
library(RColorBrewer)
theme_set( theme_classic())

plot_bar(Hx.cls, "Station", fill="Family") +
  geom_bar(stat="identity") +
    scale_fill_manual(values = getPalette(colourCount)) +
   ylab("Relative Abundance (%)") +  coord_flip() +
  guides(fill=guide_legend(ncol=3))

```


```{r, fig.align = "center", fig.cap="Hexanauplia tree (Family labeled)",  fig.width = 7}

# plot_tree(Hx.cls, shape="Order", color="Station", ladderize="left") 
library(dplyr)
Hx.df <- as_tibble(phyloseq::psmelt(Hx.cls))
colnames(Hx.df)[1] <- "label"

df <- Hx.df %>% group_by(label) %>% 
  filter (!duplicated(label)) %>% 
  select(label, Sample, Class, Order, Family, Genus)


library(ggtree)

tre = phyloseq::phy_tree(Hx.cls) # retrieve the phylo-tree in new object
x <- as_data_frame(tre)
y <- full_join(x, df, by = 'label')
tre <- NULL
tre <- y %>% tidytree::as.treedata()


library(RColorBrewer)
colourCount = length(unique(df$Family))

ggtree(tre, branch.length='none', layout='circular', aes(color=Family), na.rm = FALSE) +
  theme(legend.position="right") +
  scale_color_manual(values = c(getPalette(colourCount), "grey"), guide = guide_legend(ncol=2))
# + geom_tiplab(aes(subset=(Family=="Temoridae"))) # in process




# ggtree: https://bioconductor.org/packages/devel/bioc/vignettes/ggtree/inst/doc/treeManipulation.html
# tidy tree: https://cran.r-project.org/web/packages/tidytree/vignettes/tidytree.html
#ggtree(tre) %<+% Hx.df + geom_point2(aes(color=Order), size=5, alpha=.5, na.rm = TRUE) +  theme(legend.position="left")

# MRCA(tre, tip=c('Otu2558', "Otu0892"))

# p+geom_hilight_encircle(node=600, fill="steelblue", alpha=.6)

```




## Citas

1 Kozich JJ, Westcott SL, Baxter NT, Highlander SK, Schloss PD. (2013): Development of a dual-index sequencing strategy and curation pipeline for analyzing amplicon sequence data on the MiSeq Illumina sequencing platform. Applied and Environmental Microbiology. 79(17):5112-20

2 Yilmaz P, Parfrey LW, Yarza P, Gerken J, Pruesse E, Quast C, Schweer T, Peplies J, Ludwig W, Glöckner FO. (2014): The SILVA and "All-species Living Tree Project (LTP)" taxonomic frameworks. Nucl. Acids Res. 42:D643-D648

3 Rognes T, Flouri T, Nichols B, Quince C, Mahé F. (2016) VSEARCH: a versatile open source tool for metagenomics. PeerJ 4:e2584 

4 Westcott SL, Schloss PD. (2017). OptiClust, an improved method for assigning amplicon-based sequence data to operational taxonomic units. mSphere 2:e00073-17

5 De Vargas, C., et al. (2015) Eukaryotic plankton diversity in the sunlit ocean. Science 348.6237 1261605


```{r}
# INCLUIR PROPUESTA DE tidyamplicons EN devtools::install_github("SWittouck/tidaymplicons", build_vignettes = TRUE)
```